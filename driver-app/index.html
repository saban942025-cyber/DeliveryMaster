<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>DeliveryMaster  V33.0</title>

    <meta name="theme-color" content="#3a86ff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-touch-icon" href="../shared/icons/icon-192.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>

    <style>
        /* (Styling remains the same) */
        :root { --primary-color: #3a86ff; --primary-dark: #2f6ac2; --success-color: #28a745; --success-dark: #218838; --warning-color: #ffc107; --warning-dark: #e0a800; --danger-color: #dc3545; --danger-dark: #c82333; --bg-light: #f8f9fa; --bg-white: #ffffff; --border-color: #dee2e6; --text-dark: #212529; --text-light: #6c757d; }
        html, body { height: 100vh; overflow: hidden; } 
        body { font-family: 'Rubik', sans-serif; overscroll-behavior-y: contain; background-color: var(--bg-light); color: var(--text-dark); }
        #map { height: 250px; border-radius: 0.5rem; background-color: #e9ecef; }
        .btn { padding: 0.6rem 1rem; border-radius: 0.375rem; font-weight: 500; transition: background-color 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 0.3rem; }
        /* (Other styles omitted for brevity) */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        #login-error-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255, 255, 255, 0.95); z-index: 1000; display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 2rem; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <!-- Login Error Overlay (omitted for brevity) -->
    <div id="login-error-overlay"><i data-feather="alert-triangle" class="w-16 h-16 text-red-500 mb-4"></i><h2 class="text-2xl font-bold text-red-700 mb-2">砖转 转专转</h2><p class="text-gray-600">  驻专 .</p><p class="text-gray-600 mt-1"> 专 住 专砖 转专 砖.</p></div>

    <!-- Main Container (omitted for brevity) -->
    <div id="main-container" class="container mx-auto max-w-lg p-0 flex flex-col h-screen bg-white shadow-lg">
        <header class="bg-white shadow-sm p-4 flex justify-between items-center sticky top-0 z-10 border-b border-gray-200">
            <div><h1 class="text-xl font-bold text-gray-800">DeliveryMaster</h1><p id="driver-name-display" class="text-sm text-gray-600">: 注...</p></div>
            <div id="status-indicator" class="connecting"><span id="status-text">注...</span><span id="status-dot" class="dot"></span></div>
        </header>
        <div id="permission-section" class="p-4 space-y-3 bg-yellow-100 border-b border-yellow-300" style="display: none;"> <p class="text-sm font-medium text-yellow-800">专砖转 专砖转 拽 转专转:</p><button id="request-perms-btn" class="w-full text-sm btn btn-warning">拽砖 专砖转</button></div>
        <div class="p-4 border-b border-gray-200">
            <div id="location-info" class="bg-blue-50 p-3 rounded-lg mb-3 text-sm text-blue-800"><p id="current-location-text"> 转专 拽 ...</p><p id="eta-text" class="mt-1 font-medium hidden">...</p></div>
            <div id="map"></div>
        </div>
        <main id="order-list" class="flex-grow overflow-y-auto p-4 space-y-4 bg-gray-50">
             <div id="loading-orders" class="text-center py-10 text-gray-500"><div class="loader mx-auto mb-2"></div>注 砖转...</div>
        </main>
    </div>

    <script type="module">
        console.log('Driver App script started (V33.0)'); 

        // ---    ---
        import {
            db, auth, authReadyPromise, SmartLog, showToast,
            collection, doc, onSnapshot, query, addDoc, updateDoc,
            serverTimestamp, where, setDoc, limit, orderBy, Timestamp
        } from '../shared/firebase-init.js'; // <-- 转 住 转拽

        // ---   驻转 (砖砖 -Getters) ---
        import {
            initMap, geocodeAddress, ISRAEL_CENTER, 
            initializeMapComponents, getDriverIconActive, getOrderIconNew,
            getDriverIconStuck // 住驻转 Getters 专砖
        } from '../shared/map-utils.js'; 

        // --- Driver App Specific Logic (Adjusted) ---

        // Globals (omitted for brevity)
        let map; let driverMarker = null; let orderMarkers = {};
        let currentDriverId = localStorage.getItem('driverId');
        let currentDriverName = localStorage.getItem('driverName');
        let watchId = null; 
        let currentOrders = []; 
        let currentLatLng = null; 
        let notificationAudio = null;
        let hasNotificationPermission = false; 
        let hasGeolocationPermission = false;
        let lastLocationUpdate = 0;
        const LOCATION_UPDATE_INTERVAL = 20000; 
        const ACTIVE_DRIVER_ORDER_STATUSES = ["砖", "专"]; 
        let DOM = {}; 

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // ... (DOM assignments) ...
             initializeDriverApp(); 
             try { if(feather) { feather.replace(); } } catch (e) { SmartLog.error(e, "UI"); }
        });

        async function initializeDriverApp() {
            // ... (DOM assignments and initial checks) ...
            try { 
                // ... (Auth checks) ...

                // ** 砖 1: 转 专 驻 (Icons) **
                if (!initializeMapComponents()) { SmartLog.error("Map components init failed.", "Init"); }

                // ** 砖 2: 转 驻 **
                map = initMap(DOM.mapElement, ISRAEL_CENTER, 13);
                if (!map) { throw new Error("Map initialization failed."); }
                
                if (hasGeolocationPermission) {
                    startGeolocation();
                }

                 // ... (Notifications and Listeners logic) ...
                listenToOrders();
            } catch (error) { /* ... */ }
        }

        // ... (Status, Permissions, Geolocation, Notifications logic remains the same, adjusted to use imported functions) ...

        // --- Map Handling ---
        function updateDriverMarkerOnMap(lat, lng) { 
             if (!map) return; 
             const latLng = [lat, lng]; 
             if (driverMarker) { 
                 driverMarker.setLatLng(latLng); 
             } else { 
                 // Driver Marker Style (Blue circle)
                 driverMarker = L.circleMarker(latLng, { 
                     radius: 8, fillColor: "#3a86ff", color: "#fff", weight: 2, opacity: 1, fillOpacity: 0.9 
                 }).addTo(map); 
                 driverMarker.bindPopup(`<b>${currentDriverName}</b> (拽 )`);
                 SmartLog.info("Driver marker added", "Map"); 
             } 
        }

        function updateOrderMarkersOnMap() {
            if (!map) return;
            const activeMapOrders = currentOrders.filter(o => o.latitude && o.longitude);

            Object.keys(orderMarkers).forEach(orderId => { /* ... removal logic ... */ });

            activeMapOrders.forEach(order => {
                const latLng = [order.latitude, order.longitude];
                // ... (popup content logic) ...

                const icon = getOrderIconNew(); // <-- 砖砖 -Getter

                if (orderMarkers[order.id]) {
                    orderMarkers[order.id].setLatLng(latLng).setPopupContent(popupContent);
                } else {
                    orderMarkers[order.id] = L.marker(latLng, { icon })
                        .addTo(map)
                        .bindPopup(popupContent);
                    SmartLog.info("Order marker added", "Map", { orderId: order.id });
                }
            });

            // updateMapBounds(); // Logic remains the same
        }
        
        async function updateLocationText(lat, lng) {
            if (!DOM.currentLocationText) return; 
            DOM.currentLocationText.textContent = ` ${lat.toFixed(4)}, ${lng.toFixed(4)}`;
            // 砖砖 -geocodeAddress 
            try { 
                const coords = await geocodeAddress(`${lat},${lng}`); // Geocoding reverse should use lat,lng
                if (coords) {
                     // Reverse geocoding usually needs a specific API call, but we simulate reverse with the forward function for now.
                     // The original code used Nominatim reverse endpoint which we simulate with the imported function, but we keep the original logic for address display using Nominatim if needed.
                }
            } catch (error) { SmartLog.error(error, "GPS.ReverseGeocode"); }
        }

        // ... (Rest of the original functions are assumed present and adjusted) ...
    </script>
</body>
</html>
