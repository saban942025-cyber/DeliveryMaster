<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>DeliveryMaster v33.0 (מנהל/סידורן)</title>

    <link rel="manifest" href="./manifest.json"> 
    <meta name="theme-color" content="#1F2937"> 
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="../shared/icons/icon-192.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        /* CSS remains the same as original sidor/index2.html */
        :root {
            --primary-color: #3b82f6; --primary-dark: #2563eb; --bg-light: #f3f4f6;
            --bg-white: #ffffff; --border-color: #e5e7eb; --text-dark: #1f2937;
            --text-light: #6b7280; --bg-dark-nav: #1f2937; --text-nav: #9ca3af;
            --text-nav-active: #ffffff; --bottom-nav-height: 60px;
        }
        html, body { height: 100dvh; width: 100vw; overflow: hidden; }
        body { font-family: 'Inter', 'Arial', sans-serif; background-color: var(--bg-light); color: var(--text-dark); display: flex; flex-direction: column; }
        .app-container { flex-grow: 1; overflow: hidden; position: relative; padding-bottom: calc(var(--bottom-nav-height) + env(safe-area-inset-bottom)); }
        .app-view { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; background-color: var(--bg-light); opacity: 0; transition: opacity 0.2s ease-in-out; pointer-events: none; z-index: 1; display: flex; flex-direction: column; }
        .app-view.active { opacity: 1; pointer-events: auto; z-index: 10; }
        #bottom-navbar { position: fixed; bottom: 0; left: 0; right: 0; height: calc(var(--bottom-nav-height) + env(safe-area-inset-bottom)); background-color: var(--bg-dark-nav); color: var(--text-nav); display: flex; justify-content: space-around; align-items: flex-start; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 1000; padding: 0 5px; padding-bottom: env(safe-area-inset-bottom); }
        .nav-button { display: flex; flex-direction: column; align-items: center; justify-content: center; padding-top: 8px; border-top: 3px solid transparent; flex-grow: 1; transition: color 0.2s, border-color 0.2s; height: 100%; }
        .nav-button svg { width: 22px; height: 22px; margin-bottom: 3px; }
        .nav-button span { font-size: 0.65rem; font-weight: 500; }
        .nav-button.active { color: var(--text-nav-active); border-top-color: var(--primary-color); }
        .nav-button:not(.active):hover { color: var(--text-nav-active); }
        #view-dashboard { display: flex; flex-direction: column; }
        #dashboard-map-container { height: 45%; position: relative; background-color: #e0e0e0; flex-shrink: 0; border-bottom: 1px solid var(--border-color); }
        #map { height: 100%; width: 100%; border-radius: 0; }
        #dashboard-content { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; background-color: var(--bg-white); }
        #dashboard-tabs { display: flex; border-bottom: 1px solid var(--border-color); flex-shrink: 0; background-color: var(--bg-white); }
        .dash-tab-button { flex: 1; padding: 0.8rem 0.5rem; font-weight: 500; text-align: center; border-bottom: 3px solid transparent; color: var(--text-light); cursor: pointer; font-size: 0.9rem; }
        .dash-tab-button.active { border-bottom-color: var(--primary-color); color: var(--primary-color); }
        #dashboard-search { padding: 0.75rem; border-bottom: 1px solid var(--border-color); flex-shrink: 0; background-color: var(--bg-white); }
        #dashboard-search input { border-radius: 99px; }
        #dashboard-lists { flex-grow: 1; position: relative; overflow: hidden; }
        .panel-list { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow-y: auto; background-color: var(--bg-white); opacity: 1; }
        .panel-list:not(.active) { display: none; }
        .order-card, .driver-card { padding: 0.75rem 1rem; border-bottom: 1px solid var(--border-color); }
        .order-card.active, .driver-card.active { background-color: #eff6ff; border-right: 3px solid var(--primary-color); }
        #details-modal { max-width: 100%; width: 100%; margin: 0 auto 0 auto; border: none; border-radius: 12px 12px 0 0; background-color: var(--bg-white); box-shadow: 0 -5px 20px rgba(0,0,0,0.1); padding: 0; max-height: 70vh; overflow: hidden; }
        #details-modal::backdrop { background-color: rgba(0,0,0,0.4); backdrop-filter: blur(1px); }
        .details-modal-handle { width: 40px; height: 4px; background-color: #d1d5db; border-radius: 2px; margin: 8px auto 0 auto; }
        .details-modal-header { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1rem 0.5rem 1rem; border-bottom: 1px solid var(--border-color); }
        .details-modal-header h4 { font-weight: 600; font-size: 1.1rem; }
        .details-modal-header button { background: none; border: none; color: var(--text-light); cursor: pointer; padding: 0.25rem; }
        .details-modal-content { padding: 1rem; max-height: calc(70vh - 70px); overflow-y: auto; }
        .details-modal-content ul { list-style: none; padding: 0; margin: 0; }
        .details-modal-content li { margin-bottom: 0.5rem; font-size: 0.9rem; color: var(--text-light); }
        .details-modal-content strong { color: var(--text-dark); font-weight: 500; }
        .details-modal-content .sub-header { font-weight: 600; color: var(--text-dark); margin-top: 1rem; margin-bottom: 0.5rem; font-size: 0.95rem;}
        .details-modal-content .dist { font-weight: 500; color: var(--text-dark); display: inline-block; min-width: 50px; text-align: right; margin-left: 0.5rem; }
        .status-change-btn { margin-right: 5px; font-size: 0.75rem; color: var(--primary-color); background: none; border: none; cursor: pointer; font-weight: 500;}
        .status-change-btn:hover { text-decoration: underline;}
        .whatsapp-button { background-color: #25D366; color: white; padding: 3px 6px; border-radius: 4px; font-size: 0.75rem; cursor: pointer; border: none; display: inline-flex; align-items: center; gap: 3px;}
        .whatsapp-button:hover { background-color: #1DAE50; }
        #view-history { background-color: var(--bg-white); }
        #history-tabs { display: flex; border-bottom: 1px solid var(--border-color); flex-shrink: 0; background-color: var(--bg-white); position: sticky; top: 0; z-index: 20; }
        .history-tab-button { flex: 1; padding: 0.9rem 0.5rem; font-weight: 500; text-align: center; border-bottom: 3px solid transparent; color: var(--text-light); cursor: pointer; font-size: 0.9rem;}
        .history-tab-button.active { border-bottom-color: var(--primary-color); color: var(--primary-color); }
        .history-content { flex-grow: 1; overflow-y: auto; padding: 0.75rem; }
        .history-content h3 { font-size: 1.1rem; font-weight: 600; margin-bottom: 0.75rem; color: var(--text-dark); padding: 0 0.25rem;}
        .table-tools { display: flex; flex-direction: column; gap: 0.75rem; margin-bottom: 1rem; background-color: var(--bg-white); padding: 0.75rem; border-radius: 8px; border: 1px solid var(--border-color); }
        .table-tools input, .table-tools button { padding: 0.6rem; border-radius: 6px; border: 1px solid var(--border-color); font-size: 0.9rem; }
        .table-tools button { background-color: var(--primary-color); color: white; border: none; cursor: pointer; }
        .table-wrapper { overflow-x: auto; background-color: var(--bg-white); border-radius: 8px; border: 1px solid var(--border-color); }
        .data-table th, .data-table td { padding: 0.6rem 0.75rem; font-size: 0.8rem; }
        .data-table th { background-color: #f9fafb; }
        .data-table .action-button { padding: 4px 7px; font-size: 0.7rem; }
        .data-table .action-button i { width: 14px; height: 14px; }
        .full-modal { max-width: 100%; width: 100%; height: 100dvh; margin: 0; border-radius: 0; box-shadow: none; padding: 0; display: flex; flex-direction: column; background-color: var(--bg-light); }
        .modal-header { padding: 0.75rem 1rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background-color: var(--bg-white); flex-shrink: 0; position: sticky; top: 0; z-index: 10; }
        .modal-header h3 { font-size: 1.1rem; font-weight: 600; }
        .modal-content { flex-grow: 1; overflow-y: auto; padding: 1rem; }
        .modal-footer { padding: 0.75rem 1rem; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 0.75rem; background-color: var(--bg-white); flex-shrink: 0; position: sticky; bottom: 0; z-index: 10; }
        .modal-content label { display: block; text-sm font-medium mb-1 text-gray-700; }
        .modal-content input[type="text"], .modal-content input[type="tel"], .modal-content input[type="date"], .modal-content select, .modal-content textarea { width: 100%; padding: 0.6rem 0.75rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.9rem; background-color: var(--bg-white); }
        .modal-content select { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E"); background-position: left 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-left: 2.5rem; }
        #customer-suggestions { max-height: 150px; overflow-y: auto; border: 1px solid var(--border-color); border-top: none; background-color: white; border-radius: 0 0 6px 6px; position: absolute; width: calc(100% - 2rem); z-index: 100; }
        .suggestion-item { padding: 0.5rem 0.75rem; cursor: pointer; font-size: 0.9rem; }
        .suggestion-item:hover { background-color: #eff6ff; }
        .suggestion-item small { color: var(--text-light); font-size: 0.75rem; }
        .loader-container { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.7); display: flex; align-items: center; justify-content: center; z-index: 50; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; } @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #toast-container { position: fixed; bottom: calc(var(--bottom-nav-height) + 15px + env(safe-area-inset-bottom)); left: 50%; transform: translateX(-50%); z-index: 5000; display: flex; flex-direction: column; gap: 8px; width: calc(100% - 2rem); max-width: 400px;}
        .toast { padding: 10px 15px; background-color: var(--text-dark); color: white; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); opacity: 0; transform: translateY(20px); transition: all 0.3s ease; font-size: 0.9rem; width: 100%; }
        .toast.show { opacity: 1; transform: translateY(0); } .toast.success { background-color: #16a34a; } .toast.error { background-color: #dc2626; } .toast.info { background-color: #2563eb;} .toast.warn { background-color: #d97706;}
        #ping-modal { max-width: 90%; width: 350px; border-radius: 12px; border: none; box-shadow: 0 5px 20px rgba(0,0,0,0.1); padding: 0; }
        #ping-modal::backdrop { background-color: rgba(0,0,0,0.4); }
        .ping-option { display: block; width: 100%; text-align: right; padding: 1rem; border-bottom: 1px solid var(--border-color); cursor: pointer; font-size: 0.95rem; }
        .ping-option:hover { background-color: #f3f4f6; }
        .ping-option:last-child { border-bottom: none; }
        #ping-modal-footer { padding: 0.75rem 1rem; text-align: left; border-top: 1px solid var(--border-color); background-color: #f9fafb;}
    </style>
</head>
<body class="antialiased">

    <div class="app-container">
        <!-- Dashboard View (omitted for brevity) -->
        <main id="view-dashboard" class="app-view active">
            <div id="dashboard-map-container"><div id="map"></div><div id="map-loader" class="loader-container"><div class="loader"></div></div></div>
            <div id="dashboard-content">
                <div id="dashboard-tabs"><button id="tab-orders" class="dash-tab-button active" onclick="showPanelTab('orders')">הזמנות חדשות</button><button id="tab-drivers" class="dash-tab-button" onclick="showPanelTab('drivers')">נהגים פעילים</button></div>
                <div id="dashboard-search"><input type="text" id="search-input" placeholder="חיפוש..." class="w-full px-4 py-1.5 border rounded-full focus:outline-none focus:ring-1 focus:ring-blue-300 text-sm" onkeyup="filterLists()"></div>
                <div id="dashboard-lists"><div id="orders-list" class="panel-list active"><div class="loader-container hidden"><div class="loader"></div></div></div><div id="drivers-list" class="panel-list"><div class="loader-container hidden"><div class="loader"></div></div></div></div>
            </div>
        </main>
        <!-- History & Customers View (omitted for brevity) -->
        <div id="view-history" class="app-view">
             <div id="history-tabs"><button class="history-tab-button active" onclick="showHistoryTab('orders')">היסטוריה</button><button class="history-tab-button" onclick="showHistoryTab('customers')">לקוחות</button></div>
            <div class="history-content" id="history-orders-content">
                <h3>היסטוריית הזמנות</h3>
                <div class="table-tools"><input type="text" id="history-search" placeholder="חיפוש..."><div class="flex gap-2"><input type="date" id="history-date-from" title="מתאריך" class="flex-1"><input type="date" id="history-date-to" title="עד תאריך" class="flex-1"></div><button id="history-filter-btn" onclick="renderHistoryTable()">סנן</button></div>
                <div class="table-wrapper"><table class="data-table"><thead><tr><th>מס'</th><th>לקוח</th><th>נהג</th><th>כתובת</th><th>סטטוס</th><th>תאריך</th><th>פעולות</th></tr></thead><tbody id="history-table-body"><tr><td colspan="7" class="text-center p-4 text-gray-400">טוען...</td></tr></tbody></table></div>
            </div>
            <div class="history-content" id="history-customers-content" style="display: none;">
                <h3>ניהול לקוחות</h3>
                <div class="table-tools"><input type="text" id="customer-search-input" placeholder="חיפוש..." onkeyup="renderCustomerTable()"></div>
                <div class="table-wrapper"><table class="data-table customer-table"><thead><tr><th>שם</th><th>מס'</th><th>טלפון</th><th>כתובת</th></tr></thead><tbody id="customer-table-body"><tr><td colspan="4" class="text-center p-4 text-gray-400">טוען...</td></tr></tbody></table></div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation Bar (omitted for brevity) -->
    <nav id="bottom-navbar">
        <button class="nav-button active" onclick="showView('dashboard')"><i data-feather="map"></i><span>דשבורד</span></button>
        <button class="nav-button" onclick="showView('history')"><i data-feather="archive"></i><span>ארכיון</span></button>
        <button class="nav-button" onclick="openNewOrderForm()"><i data-feather="plus-circle"></i><span>הזמנה</span></button>
        <button class="nav-button" onclick="openPingOptionsModal()"><i data-feather="bell"></i><span>התראה</span></button>
         <a href="log.html" target="_blank" class="nav-button"><i data-feather="file-text"></i><span>לוגים</span></a>
    </nav>

    <!-- Details Modal, New Order Modal, Edit Customer Modal, Ping Options Modal (omitted for brevity) -->
    <dialog id="details-modal">
         <div class="details-modal-handle"></div>
        <div class="details-modal-header"><h4 id="details-modal-title">פרטים</h4><div><button id="details-whatsapp-btn" class="whatsapp-button mr-2 hidden" onclick="handleWhatsAppAction()" title="פעולות וואטסאפ"><i class="fab fa-whatsapp"></i></button><button id="details-copy-link-btn" class="hidden mr-1" onclick="copyCustomerLinkFromDetails()" title="העתק לינק ללקוח"><i data-feather="share-2"></i></button><button onclick="closeDetailsModal()"><i data-feather="x"></i></button></div></div>
        <div class="details-modal-content" id="details-modal-body">טוען...</div>
    </dialog>
    <dialog id="new-order-modal" class="full-modal">
        <form onsubmit="submitNewOrder(event)">
            <div class="modal-header"><h3>יצירת הזמנה חדשה</h3><button type="button" onclick="closeNewOrderForm()"><i data-feather="x"></i></button></div>
            <div class="modal-content space-y-4">
                <div class="relative"><label for="customer-search" class="block text-sm font-medium mb-1">לקוח (חיפוש או חדש)</label><input type="text" id="customer-search" class="w-full p-2 border rounded-md" oninput="handleCustomerSearch(this.value)" autocomplete="off" placeholder="התחל להקליד שם..."><div id="customer-suggestions" class="absolute left-0 right-0 mt-1 hidden"></div></div>
                <div id="new-customer-fields" class="p-3 bg-blue-50 border border-blue-200 rounded-lg space-y-3" style="display: none;"> <p class="font-semibold text-blue-700 text-sm">פרטי לקוח חדש</p><input type="hidden" id="customer-id-new"><input type="text" id="customer-name-new" placeholder="שם מלא *" class="w-full p-2 border rounded-md text-sm"><input type="tel" id="customer-phone-new" placeholder="טלפון *" class="w-full p-2 border rounded-md text-sm"><div class="grid grid-cols-3 gap-2"><input type="text" id="customer-street-new" placeholder="רחוב *" class="w-full p-2 border rounded-md text-sm col-span-2"><input type="text" id="customer-streetnum-new" placeholder="מס' *" class="w-full p-2 border rounded-md text-sm"></div><input type="text" id="customer-city-new" placeholder="עיר *" class="w-full p-2 border rounded-md text-sm"><input type="text" id="customer-contact-new" placeholder="איש קשר" class="w-full p-2 border rounded-md text-sm"><input type="text" id="customer-number-new" placeholder="מס' לקוח" class="w-full p-2 border rounded-md text-sm"> </div>
                 <div id="existing-customer-display" class="p-3 bg-gray-100 border rounded-lg text-sm space-y-1" style="display: none;"><input type="hidden" id="customer-id-existing"><div class="flex justify-between items-center"><span><strong>לקוח:</strong> <span id="customer-name-display"></span> <span id="customer-number-display" class="text-xs text-gray-500"></span></span><button type="button" onclick="clearCustomerSelection()" class="text-xs text-red-600 font-medium">נקה בחירה</button></div><p><strong>כתובת:</strong> <span id="customer-address-display"></span></p><p><strong>טלפון:</strong> <span id="customer-phone-display"></span></p></div>
                <hr><h4 class="font-medium text-gray-700">פרטי הזמנה</h4><div><label for="order-number" class="block text-sm font-medium mb-1">מס' הזמנה (אופציונלי)</label><input type="text" id="order-number" placeholder="ריק = מזהה אוטומטי" class="w-full p-2 border rounded-md text-sm"></div><div class="grid grid-cols-2 gap-4"><div><label for="order-date" class="block text-sm font-medium mb-1">תאריך</label><input type="date" id="order-date" class="w-full p-2 border rounded-md text-sm" required></div><div><label for="order-delivery-type" class="block text-sm font-medium mb-1">סוג הובלה</label><select id="order-delivery-type" class="w-full p-2 border rounded-md text-sm bg-white" required><option value="">בחר...</option><option value="הובלת מנוף">מנוף</option><option value="הובלת משאית">משאית</option><option value="איסוף עצמי">איסוף</option></select></div></div>
                <div><label for="order-warehouse" class="block text-sm font-medium mb-1">מחסן</label><select id="order-warehouse" class="w-full p-2 border rounded-md text-sm bg-white" required><option value="">בחר...</option><option value="החרש">החרש</option><option value="התלמיד">התלמיד</option></select></div>
                <div><label for="order-notes" class="block text-sm font-medium mb-1">הערות</label><textarea id="order-notes" rows="3" placeholder="הערות להזמנה..." class="w-full p-2 border rounded-md text-sm"></textarea></div>
            </div>
            <div class="modal-footer"><button type="button" class="btn-secondary" onclick="closeNewOrderForm()">ביטול</button><button type="submit" id="submit-order-btn" class="btn-primary">צור הזמנה</button></div>
        </form>
    </dialog>
    <dialog id="customer-edit-modal" class="full-modal">
        <form onsubmit="handleSaveCustomer(event)"><input type="hidden" id="customer-edit-id">
            <div class="modal-header"><h3 id="customer-edit-title">עריכת לקוח</h3><button type="button" onclick="closeCustomerEditModal()"><i data-feather="x"></i></button></div>
            <div class="modal-content space-y-4">
                 <div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium mb-1">שם*</label><input type="text" id="customer-edit-name" class="w-full p-2 border rounded-md text-sm" required></div><div><label class="block text-sm font-medium mb-1">מס' לקוח</label><input type="text" id="customer-edit-number" class="w-full p-2 border rounded-md text-sm"></div></div>
                 <div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium mb-1">טלפון*</label><input type="tel" id="customer-edit-phone" class="w-full p-2 border rounded-md text-sm" required></div><div><label class="block text-sm font-medium mb-1">איש קשר</label><input type="text" id="customer-edit-contact" class="w-full p-2 border rounded-md text-sm"></div></div>
                 <hr><h4 class="font-medium text-gray-700">כתובת ברירת מחדל*</h4>
                 <div class="grid grid-cols-3 gap-2"><input type="text" id="customer-edit-street" placeholder="רחוב" class="w-full p-2 border rounded-md text-sm col-span-2" required><input type="text" id="customer-edit-streetnum" placeholder="מס'" class="w-full p-2 border rounded-md text-sm" required></div>
                 <input type="text" id="customer-edit-city" placeholder="עיר" class="w-full p-2 border rounded-md text-sm" required>
                 <div><label class="block text-sm font-medium mb-1">קואורדינטות (lat, lon)</label><input type="text" id="customer-edit-coords" placeholder="הדבק מ-Google Maps (אופציונלי)" class="w-full p-2 border rounded-md text-sm"><p class="text-xs text-gray-500 mt-1">למיקום מדויק בהזמנות</p></div>
                 <div class="mt-4 border-t pt-3"><h4 class="text-sm font-medium text-gray-600 mb-1">היסטוריית שינויים</h4><ul id="customer-audit-log" class="text-xs text-gray-500 space-y-1 max-h-20 overflow-y-auto bg-gray-50 p-2 rounded border"></ul></div>
            </div>
            <div class="modal-footer"><button type="button" class="btn-secondary" onclick="closeCustomerEditModal()">ביטול</button><button type="submit" id="customer-save-btn" class="btn-primary">שמור שינויים</button></div>
        </form>
    </dialog>
    <dialog id="ping-modal">
        <div class="details-modal-handle" style="background-color: #9ca3af;"></div>
        <h3 class="text-lg font-semibold p-4 pb-2 text-center">בחר הודעת התראה</h3>
        <div id="ping-options-list"></div>
        <div class="ping-option font-medium" onclick="selectPingOption('custom')"><i data-feather="edit-3" class="inline-block w-4 h-4 ml-2"></i>הודעה מותאמת אישית...</div>
         <div id="ping-modal-footer"><button type="button" class="text-sm text-gray-600 hover:text-gray-800" onclick="closePingOptionsModal()">ביטול</button></div>
    </dialog>

    <div id="toast-container"></div>

    <script type="module">
        // --- ייבוא מודולי ליבה ---
        import {
            db, auth, authReadyPromise, functions, SmartLog, showToast,
            collection, doc, onSnapshot, query, orderBy, addDoc, updateDoc,
            serverTimestamp, deleteDoc, arrayUnion, where, getDocs, setDoc, limit, getDoc,
            Timestamp
        } from '../shared/firebase-init.js';

        // --- ייבוא מודול מפות (שימוש ב-Getters) ---
        import {
            initMap, geocodeAddress, ISRAEL_CENTER, WAREHOUSE_LOCATIONS,
            initializeMapComponents, getDriverIconActive, getDriverIconStuck, getOrderIconNew,
            updateMarker, removeOldMarkers, fitMapToBounds, calculateRouteDistance
        } from '../shared/map-utils.js';

        // --- (State and Config) ---
        const ALLOWED_STATUSES = ["חדש", "שויך", "בדרך", "הושלם", "בוטל"];
        let state = { orders: [], drivers: [], liveLocations: {}, customers: [] };
        let map; let driverMarkers = {}; let orderMarkers = {};
        let currentDetailsItem = null; let customerSearchTimeout = null;

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            try { feather.replace(); } catch(e) { SmartLog.error(e, "Init.Feather"); }
            initializeApplication();
            const orderDateInput = document.getElementById('order-date');
            if(orderDateInput) orderDateInput.value = new Date().toISOString().split('T')[0];
        });

        async function initializeApplication() {
            SmartLog.info("Sidor App v33.0: Initializing...", "Init");
            showLoader('map-loader', true);
            showLoader('orders-list', true);
            showLoader('drivers-list', true);
            try {
                // ** שלב 1: אתחול רכיבי המפה (Icons) **
                if (!initializeMapComponents()) { throw new Error("Map components initialization failed."); }
                
                // ** שלב 2: אתחול המפה **
                map = initMap('map'); 
                if (!map) { throw new Error("Map initialization failed."); }

                await authReadyPromise;
                SmartLog.info(`Auth successful.`, "Init.Auth");
                
                // Start listeners
                listenToDrivers(); listenToOrders(); listenToLocations(); listenToCustomers();
                
                document.getElementById('history-filter-btn')?.addEventListener('click', renderHistoryTable);
                
                showView('dashboard'); 
            } catch (error) {
                SmartLog.error(error, "Init.Critical"); showToast(`שגיאת אתחול: ${error.message}`, 'error');
            } finally {
                 showLoader('map-loader', false); showLoader('orders-list', false); showLoader('drivers-list', false);
            }
        }
        
        // --- FIRESTORE LISTENERS (Logic remains the same) ---
        function listenToDrivers() { /* ... */ }
        function listenToOrders() { /* ... */ }
        function listenToLocations() { /* ... */ }
        function listenToCustomers() { /* ... */ }

        // --- RENDER FUNCTIONS (Adjusted to use Getters) ---
        function renderDrivers() { /* ... */ }
        function createDriverCard(driver, location, assignedCount) { /* ... */ }
        function renderOrders() { /* ... */ }
        function createOrderCard(order) { /* ... */ }
        
        function renderMapMarkers() {
            if (!map) return;
            const bounds = L.latLngBounds();

            // Drivers (using Getters)
            Object.values(state.liveLocations).forEach(driverLoc => {
                // ... (existing logic) ...
                const icon = driverLoc.isStuck ? getDriverIconStuck() : getDriverIconActive(); // <-- שימוש ב-Getter
                if (driverMarkers[driverLoc.id]) {
                    driverMarkers[driverLoc.id].setLatLng(latLng).setIcon(icon).setPopupContent(popupContent);
                } else {
                    driverMarkers[driverLoc.id] = L.marker(latLng, { icon }).addTo(map).bindPopup(popupContent).on('click', () => focusOnMapItem(driverLoc.id, 'driver'));
                }
                // ...
            });
            // ... (remove old drivers logic) ...

            // Orders (using Getters)
            const unassignedOrders = state.orders.filter(o => o.status === 'חדש' && o.latitude && o.longitude);
            // ... (remove old orders logic) ...
            unassignedOrders.forEach(order => {
                const icon = getOrderIconNew(); // <-- שימוש ב-Getter
                // ... (existing logic) ...
                if (orderMarkers[order.id]) {
                    orderMarkers[order.id].setLatLng(latLng).setPopupContent(popupContent);
                } else {
                    orderMarkers[order.id] = L.marker(latLng, { icon }).addTo(map).bindPopup(popupContent).on('click', () => focusOnMapItem(order.id, 'order'));
                }
                // ...
            });

            // Fit bounds logic (using imported function)
             if (bounds.isValid() && (unassignedOrders.length > 0 || Object.values(state.liveLocations).length > 0 )) {
                 try { map.fitBounds(bounds, { padding: [50, 50], maxZoom: 15 }); } catch (e) { console.warn("FitBounds error:", e); }
            } else if (map.getZoom() > 9) { 
                map.setView(ISRAEL_CENTER, 9);
            }
        }
        
        // --- UI, Interactions, and CRUD (Logic remains the same, imports are now correct) ---
        function showView(viewName) { /* ... */ }
        window.showView = showView;
        // ... (other UI functions) ...
        
        // --- Geocoding (Uses imported function) ---
        // async function geocodeAddress(address) { /* ... Removed local implementation ... */ }

        // --- NEW ORDER FORM (submitNewOrder uses imported geocodeAddress) ---
        async function submitNewOrder(event) { 
            event.preventDefault();
            const btn = document.getElementById('submit-order-btn');
            if (!btn) return;
            btn.disabled = true; btn.innerText = 'מעבד...';
            // ... (customer logic) ...
            try {
                // ... (customer logic and validation) ...
                btn.innerText = 'מאתר כתובת...';
                let finalCoords;
                if (useCustomerCoords) { finalCoords = customerCustomCoords; }
                else {
                    const coords = await geocodeAddress(customerAddress); // <-- שימוש בפונקציה המיובאת
                    const selectedWarehouse = document.getElementById('order-warehouse').value;
                    const warehouseCoords = WAREHOUSE_LOCATIONS[selectedWarehouse] || ISRAEL_CENTER;
                    finalCoords = coords || warehouseCoords;
                    if (!coords) showToast('כתובת לא אותרה, מוצג במיקום מחסן', 'warn');
                }
                // ... (order creation logic) ...
            } catch (error) { /* ... */ }
            finally { btn.disabled = false; btn.innerText = 'צור הזמנה'; }
        }
        window.submitNewOrder = submitNewOrder;

        // --- CUSTOMER EDIT MODAL (handleSaveCustomer uses imported geocodeAddress) ---
        async function handleSaveCustomer(event) {
             event.preventDefault();
             // ... (existing logic) ...
             if (addressChanged && !newCoords) {
                 btn.innerText = 'מאתר כתובת...';
                 const geocodedCoords = await geocodeAddress(fullAddress); // <-- שימוש בפונקציה המיובאת
                 if (geocodedCoords) newCoords = geocodedCoords; else showToast('אזהרה: לא ניתן לאתר קואורדינטות', 'warn');
                 btn.innerText = 'שומר...';
             }
             // ... (rest of the save logic) ...
        }
        window.handleSaveCustomer = handleSaveCustomer;

        // --- (Rest of the functions are assumed present and adjusted) ---
    </script>
     <script>
        // Service Worker Registration (Remains the same)
        if ('serviceWorker' in navigator) {
             window.addEventListener('load', () => {
                 navigator.serviceWorker.register('./sw.js') 
                     .then(reg => console.log('Admin SW registered:', reg.scope))
                     .catch(err => console.error('Admin SW registration failed:', err));
             });
         }
    </script>
</body>
</html>
