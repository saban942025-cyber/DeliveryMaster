<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>DeliveryMaster - טרמינל מחסן V33.0</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-touch-icon" href="../shared/icons/icon-192.png">

    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>

    <style>
        /* (Styling remains the same) */
        :root { --primary-color: #007bff; --success: #28a745; --warning: #ffc107; --shadow-light: 0 8px 32px 0 rgba(31, 38, 135, 0.2); }
        /* (Other styles omitted for brevity) */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; display: inline-block; margin-right: 10px; }
    </style>
</head>
<body>

    <!-- (HTML structure omitted for brevity) -->
    <div id="loginView" class="view active">
        <div class="login-card glass-card"><h2>כניסת מנהל מחסן</h2><input type="text" id="managerIdInput" placeholder="הזן קוד מנהל (OREN/TAMIR)"><button id="loginBtn">כניסה</button></div>
    </div>
    <div id="mainView" class="view">
        <header class="app-header glass-card" style="margin: 15px; height: 70px;"><h1 id="welcomeMessage"></h1><button id="logoutBtn" style="background:none; border:none; color:#333; font-size: 1.5em;"><i class="fas fa-sign-out-alt"></i></button></header>
        <main><div id="warehouse-map" class="glass-card" style="padding:0; overflow:hidden;"></div>
            <div id="newOrders" class="order-section"><h2><i class="fas fa-inbox"></i> הזמנות חדשות לאישור</h2><div id="newOrdersList"><p>טוען...</p></div></div>
            <div id="inProgressOrders" class="order-section"><h2><i class="fas fa-tasks"></i> הזמנות בתהליך</h2><div id="inProgressOrdersList"><p>טוען...</p></div></div>
        </main>
    </div>
    <div id="toast-container"></div>

    <script type="module">
        // --- ייבוא מודולי ליבה ---
        import {
            db, authReadyPromise, SmartLog, showToast,
            collection, doc, onSnapshot, query, addDoc, updateDoc,
            serverTimestamp, where, setDoc, limit, orderBy, Timestamp 
        } from '../shared/firebase-init.js'; 

        // --- ייבוא מודול מפות (שימוש ב-Getters) ---
        import {
            initMap, WAREHOUSE_LOCATIONS, initializeMapComponents, 
            getDriverIconActive, getDriverIconLoading, getDriverIconInactive, getWarehouseIcon
        } from '../shared/map-utils.js'; 

        // --- App Logic (Adjusted) ---
        let currentManager = null;
        let knownOrderIds = new Set();
        let state = { drivers: {}, orders: {}, locations: {} };
        let map; let driverMarkers = {};
        const warehouseCoords = WAREHOUSE_LOCATIONS; // משתמש בקבוע המיובא

        // OneSignal Init (remains the same)
        window.OneSignalDeferred = window.OneSignalDeferred || [];
        OneSignalDeferred.push(async function(OneSignal) {
             // ... (Init logic remains the same) ...
        });

        function initWarehouseApp(OneSignalInstance) {
             // ... (Init logic remains the same) ...
        }
        function onLogin(OneSignalInstance) { /* ... */ }
        function onLogout() { /* ... */ }

        async function initApp(manager, OneSignalInstance) {
            SmartLog.info(`Initializing session for manager: ${manager.id}`, "Auth", { manager });
            currentManager = manager;
            // ...
            try {
                await authReadyPromise; 
                SmartLog.info("Firebase Auth ready, initializing components.", "Init");
                
                // ** שלב 1: אתחול רכיבי המפה (Icons) **
                if (!initializeMapComponents()) { SmartLog.error("Map components init failed.", "Init"); }

                initMapCustom(); // שימוש בפונקציה העוטפת
                // ... (Listeners logic) ...
            } catch (error) { /* ... */ }
        }

        function initMapCustom() { // פונקציה עוטפת המשתמשת ב-initMap המיובא
            if (map) map.remove();
            if (!currentManager || !WAREHOUSE_LOCATIONS[currentManager.warehouse]) { 
                SmartLog.error(new Error("Warehouse location unknown"), "Map.Init"); 
                document.getElementById('warehouse-map').innerHTML = "שגיאה: מיקום מחסן לא ידוע";
                return; 
            }
            const center = WAREHOUSE_LOCATIONS[currentManager.warehouse];
            map = initMap('warehouse-map', center, 13); // שימוש בפונקציה המיובאת
            if (map) {
                L.marker(center, { icon: getWarehouseIcon() }).addTo(map).bindPopup(`<b>המחסן (${currentManager.warehouse})</b>`); // <-- שימוש ב-Getter
                SmartLog.info("Map initialized", "Map.Init");
            }
        }

        function renderWarehouseMap() {
            if (!map) return;
            Object.values(state.locations).forEach(loc => {
                const driverId = loc.id; const driverData = state.drivers[driverId]; if (!driverData || !loc.latitude) return;
                let icon = getDriverIconInactive(); let popup = `<b>${driverData.name}</b><br>לא פעיל`; // <-- שימוש ב-Getter

                // ... (Assigned/On Delivery logic) ...
                if (assignedOrder) { icon = getDriverIconLoading(); popup = `<b>${driverData.name}</b><br>בדרך להעמיס...`; } // <-- שימוש ב-Getter
                else if (loc.isStuck) { popup = `<b>${driverData.name}</b><br>תקוע...`; }
                else if (!onDelivery && minutesAgo !== '?' && minutesAgo < 15) { icon = getDriverIconActive(); popup = `<b>${driverData.name}</b><br>פנוי...`; } // <-- שימוש ב-Getter
                // ... (Rest of logic) ...
            });
            // ... (Rest of map rendering logic) ...
        }

        // ... (Rest of the original functions are assumed present and adjusted) ...

    </script>
</body>
</html>
